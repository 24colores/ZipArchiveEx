<?php

require('vendor/autoload.php');
use 
require('src/ZipArchiveEx.php');

class ZipArchiveExTest extends PHPUnit_Framework_TestCase {

	public static $tmpDir;

	public function provideTestDirs() {
		return array(
			array('invalid dir', false, null),
			array('tests/zipme', true, null),
			array('tests/zipme', true, 'README'),
		);
	}


	public function setUp() {
		# Get temporary directory:
		self::$tmpDir = sys_get_temp_dir();

		# Remove extracted testdirectory:
		FileSystemManager::rrmdir();
	}


	/**
	 * @dataProvider provideTestDirs
	 */
	public function testAddDir($dirname, $expected_result, $manipulate) {
		# Create new archive
		$archive = '/tmp/archive.zip';
		$zip = new ZipArchiveEx();
		$zip->open($archive, ZIPARCHIVE::OVERWRITE);

		# Try to add directory:
		$result = $zip->addDir($dirname);
		$this->assertEquals($expected_result, $result);

		# Close archive:
		$zip->close();

		# If directory was added successfully
		if ($result) {
			# Extract directory
			$output = array();
			# -u Option forces update of already existing files,
			# importang for testing on travis-ci.org!
			exec('unzip -u ' . $archive . ' -d ' . $self::$tmpDir,
				$output,
				$result);
			$this->assertEquals(0, $result); # 0 = successfull

			# $manipulate holds the file to manipulate,
			# so the following assertion fails.
			$extractionDir = self::$tmpDir . '/' . basename($dirname);
			if ($manipulate) {
				file_put_contents(
					$extractionDir . '/' . $manipulate,
					'Lorem ipsum dolor sit amet.');
				$expected_result = 1;
			} else {
				$expected_result = 0;
			}

			# Compare extracted directory and original one
			exec('diff -arq ' . $dirname . ' ' . $extractionDir, $output, $result);
			LogMore::debug('Output of diff-command: %s', implode(PHP_EOL, $output));
			LogMore::debug('Expecting %d, got: %d',
				$expected_result,
				$result);
			$this->assertEquals($expected_result, $result);
		}
	}

};

